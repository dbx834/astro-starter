---
/**
 * OrgAndNewsOrgLd.astro â€” outputs Organization + NewsMediaOrganization JSON-LD
 *
 * Minimal required props:
 * - siteUrl : absolute origin, e.g. "https://example.com"
 * - name    : organization name
 *
 * Optional props (all graceful fallbacks):
 * - url                   : absolute or relative (defaults to siteUrl)
 * - legalName             : string
 * - alternateName         : string | string[]
 * - description           : string
 * - logo                  : string (abs/rel) or { url, width?, height? }
 * - sameAs                : string[]
 * - inLanguage            : string (default "en")
 * - email                 : string
 * - telephone             : string
 * - areaServed            : string | string[]
 * - foundingDate          : ISO date
 * - founders              : { name, url? }[]
 * - parentOrganization    : { name, url? } | string
 * - address               : {
 *      streetAddress?, addressLocality?, addressRegion?, postalCode?, addressCountry?
 *   }
 * - contactPoints         : ContactPoint[]  // see below
 * - taxID                 : string
 * - duns                  : string
 * - naics                 : string
 * - awards                : string | string[]
 *
 * NewsMediaOrganization-specific (optional):
 * - publishingPrinciples              : string (abs/rel URL)
 * - correctionsPolicy                 : string
 * - diversityPolicy                   : string
 * - ethicsPolicy                      : string
 * - verificationFactCheckingPolicy    : string
 * - masthead                          : string
 * - missionCoveragePrioritiesPolicy   : string
 * - actionableFeedbackPolicy          : string
 * - coverageStartTime                 : ISO date
 * - ownershipFundingInfo              : string
 *
 * ContactPoint:
 * { contactType (req), email?, telephone?, areaServed?, availableLanguage?, url? }
 */

const {
  // minimal
  siteUrl = "https://auroville.today",
  name = "Auroville Today",

  // general
  url,
  legalName,
  alternateName,
  description,
  logo,
  sameAs = [],
  inLanguage = "en",
  email,
  telephone,
  areaServed,
  foundingDate,
  founders = [],
  parentOrganization,
  address,
  contactPoints = [],
  taxID,
  duns,
  naics,
  awards,

  // news-specific
  publishingPrinciples,
  correctionsPolicy,
  diversityPolicy,
  ethicsPolicy,
  verificationFactCheckingPolicy,
  masthead,
  missionCoveragePrioritiesPolicy,
  actionableFeedbackPolicy,
  coverageStartTime,
  ownershipFundingInfo,
} = Astro.props;

// ---------- helpers ----------
const trimSlash = (s = "") => s.replace(/\/+$/, "");
const ensureAbs = (u) => {
  if (!u) return undefined;
  if (/^https?:\/\//i.test(u)) return u;
  return trimSlash(siteUrl || "") + (u.startsWith("/") ? u : "/" + u);
};
const defined = (v) => v !== undefined && v !== null && v !== "";
const prune = (obj) => {
  if (Array.isArray(obj)) {
    const a = obj.map(prune).filter(defined);
    return a.length ? a : undefined;
  }
  if (obj && typeof obj === "object") {
    const out = {};
    for (const [k, v] of Object.entries(obj)) {
      const pv = prune(v);
      if (defined(pv)) out[k] = pv;
    }
    return Object.keys(out).length ? out : undefined;
  }
  return defined(obj) ? obj : undefined;
};
const toArray = (x) => (Array.isArray(x) ? x : defined(x) ? [x] : []);

// ---------- compute shared bits ----------
const orgId = ensureAbs("/#org");
const newsId = ensureAbs("/#newsorg");
const orgUrl = ensureAbs(url || "/");
const logoObj = (() => {
  if (!defined(logo)) return undefined;
  if (typeof logo === "string") {
    return { "@type": "ImageObject", url: ensureAbs(logo) };
  }
  return prune({
    "@type": "ImageObject",
    url: ensureAbs(logo.url),
    width: logo.width,
    height: logo.height,
  });
})();

const foundersArr = toArray(founders)
  .map((f) =>
    prune({
      "@type": "Person",
      name: f?.name,
      url: f?.url ? ensureAbs(f.url) : undefined,
    }),
  )
  .filter(Boolean);

const parentOrgObj = (() => {
  if (!defined(parentOrganization)) return undefined;
  if (typeof parentOrganization === "string") {
    return { "@type": "Organization", name: parentOrganization };
  }
  return prune({
    "@type": "Organization",
    name: parentOrganization?.name,
    url: parentOrganization?.url
      ? ensureAbs(parentOrganization.url)
      : undefined,
  });
})();

const addressObj = address
  ? prune({
      "@type": "PostalAddress",
      streetAddress: address.streetAddress,
      addressLocality: address.addressLocality,
      addressRegion: address.addressRegion,
      postalCode: address.postalCode,
      addressCountry: address.addressCountry,
    })
  : undefined;

const contactPointsArr = toArray(contactPoints)
  .map((c) =>
    prune({
      "@type": "ContactPoint",
      contactType: c?.contactType,
      email: c?.email,
      telephone: c?.telephone,
      areaServed: c?.areaServed,
      availableLanguage: c?.availableLanguage,
      url: c?.url ? ensureAbs(c.url) : undefined,
    }),
  )
  .filter(Boolean);

const sameAsClean = toArray(sameAs).filter(Boolean);

// ---------- Organization ----------
const organization = prune({
  "@context": "https://schema.org",
  "@type": "Organization",
  "@id": orgId,
  url: orgUrl,
  name: name,
  legalName: legalName,
  alternateName: toArray(alternateName).length
    ? toArray(alternateName)
    : undefined,
  description: description,
  // "inLanguage": inLanguage,
  logo: logoObj,
  email: email,
  telephone: telephone,
  areaServed: toArray(areaServed).length ? toArray(areaServed) : undefined,
  foundingDate: foundingDate,
  founder: foundersArr.length ? foundersArr : undefined,
  parentOrganization: parentOrgObj,
  address: addressObj,
  contactPoint: contactPointsArr.length ? contactPointsArr : undefined,
  taxID: taxID,
  duns: duns,
  naics: naics,
  award: toArray(awards).length ? toArray(awards) : undefined,
  sameAs: sameAsClean.length ? sameAsClean : undefined,
});

// ---------- NewsMediaOrganization ----------
const newsOrg = prune({
  "@context": "https://schema.org",
  "@type": "NewsMediaOrganization",
  "@id": newsId,
  name: name,
  url: orgUrl,
  // "inLanguage": inLanguage,
  logo: logoObj,
  parentOrganization: { "@id": orgId },
  sameAs: sameAsClean.length ? sameAsClean : undefined,

  // Google-recommended newsroom policy links (URLs; relative OK)
  publishingPrinciples: ensureAbs(publishingPrinciples),
  correctionsPolicy: ensureAbs(correctionsPolicy),
  diversityPolicy: ensureAbs(diversityPolicy),
  ethicsPolicy: ensureAbs(ethicsPolicy),
  verificationFactCheckingPolicy: ensureAbs(verificationFactCheckingPolicy),
  masthead: ensureAbs(masthead),
  missionCoveragePrioritiesPolicy: ensureAbs(missionCoveragePrioritiesPolicy),
  actionableFeedbackPolicy: ensureAbs(actionableFeedbackPolicy),

  // Optional transparency bits
  ownershipFundingInfo: ownershipFundingInfo,
  // "coverageStartTime": coverageStartTime
});

// Dev guard for minimal props
if (!siteUrl || !name) {
  console.warn("[OrgAndNewsOrgLd] Missing required props: siteUrl, name");
}
---

{
  organization && (
    <script
      type="application/ld+json"
      set:html={JSON.stringify(organization)}
    />
  )
}

{
  newsOrg && (
    <script type="application/ld+json" set:html={JSON.stringify(newsOrg)} />
  )
}
